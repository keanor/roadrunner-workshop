<blockquote>Вопросы код-ревью меня интересуют очень давно. Много раз возникали те или иные проблемы то с качеством кода, то с климатом в коллективе. И действительно, code review — это если не единственное, то одно из самых главных мест для возникновения конфликтов в коллективе разработчиков. </blockquote><p>И вот недавно при подготовке к очередному выпуску подкаста "<a href="https://soundcloud.com/znprod">Цинковый прод</a>" я узнаю, что Google <a href="https://google.github.io/eng-practices/review/reviewer/">опубликовал</a> свод правил по проведению Code Review, битком набитый ценными мыслями. Весь материал довольно объемный и не влезет в одну статью, поэтому я постараюсь выделить наиболее интересные (мне) мысли. </p><br>
<p>Итак, поехали </p><br>
<p><strong>Термины, используемые в оригинальной статье:</strong></p><br>
<p><strong>CL</strong> — changelist. Но обычно это называют Merge Request или Pull Request, поэтому в статье я буду использовать сокращение <strong>MR</strong></p><br>
<p><strong>LGTM</strong> — Looks Good to Me. Короче, когда жмут кнопку "approve". Я буду использовать термин "апрув", как более понятный населению.</p><br>
<h2 id="idealnost-mr">Идеальность MR</h2><br>
<p>На практике можно встретить различные крайности при рассмотрении MR. Кто-то всей командой задалбывает замечаниями, пока всё до мелочей не будет исправлено, кто-то смотрит примерно логику и жмёт "апрув". </p><br>
<p>В Гугловском документе написана интересная мысль. MR не должен быть идеальным, но он должен улучшать кодовую базу. Т.е с каждым привносимым изменением код должен становиться лучше и лучше. И если MR добавляет много хорошего, то не надо придираться к мелочам; выгоднее, чтобы это улучшение попало в код побыстрее.</p><br>
<p>Никакой MR не должен делать код хуже. Единственное исключение — это если MR является срочным фиксом чего-нибудь.</p><br>
<h2 id="svoboda-delat-zamechaniya">Свобода делать замечания</h2><br>
<p>Несмотря на то, что нельзя задалбывать мелочами, тем не менее можно свободно эти мелочи писать хоть к каждой строчке. Противоречие с предыдущим пунктом решается просто: мелочи и придирки ревьювер помечает префиксом "nit:" от англ. nitpick (придирка). Такие замечания фиксить необязательно, однако автор MR может захотеть что-то исправить или, даже если нет, учесть на будущее некоторые моменты.</p><br>
<h2 id="fakty-vazhnee-personalnyh-predpochteniy">Факты важнее персональных предпочтений</h2><br>
<p>Почти всегда стандартные принципы построения ПО (software design), базирующиеся на лучших практиках, лучше, чем хитровымученные велосипеды. Поэтому препочтение нужно отдавать им.<br>
    Если можно применить несколько стандартных подходов, то это на усмотрение автора.<br>
    Прямая цитата для лучшего понимания: </p><br>
<blockquote>Aspects of software design are almost never a pure style issue or just a personal preference. They are based on underlying principles and should be weighed on those principles, not simply by personal opinion. Sometimes there are a few valid options. If the author can demonstrate (either through data or based on solid engineering principles) that several approaches are equally valid, then the reviewer should accept the preference of the author. Otherwise the choice is dictated by standard principles of software design.</blockquote><br>
<h2 id="esli-revyuver-i-avtor-mr-ne-soglasny-drug-s-drugom">Если ревьювер и автор MR не согласны друг с другом</h2><br>
<p>Сначала идет попытка достигнуть консенсуса в комментариях к MR. Если это не получается, то личное обсуждение. Если все равно не пришли к единому мнению, то привлекать членов команды. Но главное, MR не должен застревать надолго из-за несогласия двух человек. </p><br>
<p>Обсудили в коментах -&gt; Обсудили лично -&gt; Обсудили в команде -&gt; Двигаемся дальше</p><br>
<h2 id="skorost-proverki-mr">Скорость проверки MR</h2><br>
<p>Скорость экстремально важна. Если раз в несколько дней давать по одному комменту, то автор MR будет жаловаться, что к нему придираются и не дают работать. </p><br>
<p>Если MR проверяется очень быстро, то любые замечания не будут являться большой проблемой — ведь их фиксы тут проверят, и таск пройдет дальше.</p><br>
<p>В Гугле советуют не отвлекаться от фокусировки над своей задачи, но если уж отвлеклись, то просмотреть, нет ли чего-то поревьювить. Например, вернулся с обеда — поревьювил. Пришел на работу — поревьювил. И т.д. </p><br>
<h2 id="poryadok-prosmotra-mr">Порядок просмотра MR</h2><br>
<p>Сначала надо просмотреть MR в целом. Надо ли это вообще, в правильном ли месте код (или это должно быть в отдельной библиотеке), есть ли какие-то глобальные проблемы.<br>
    Т.е. нет смысла смотреть какие-то детали реализации, если код вообще не туда и не для того.</p><br>
<p>Вообще, порядок просмотра важен, чтобы как можно быстрее выдавать автору фидбек (смотри предыдущий пункт).</p><br>
<p>Когда посмотрели MR вцелом, надо пройтись по основным файлам, т.е. проверить самое главное (если непонятно, что самое главное, можно спросить у разработчика).</p><br>
<p>Опять же, о любых проблемах нужно сообщать сразу, даже если вы еще не досмотрели MR и решили вообще досмотреть его позже.</p><br>
<p>Далее надо выбрать логичную последовательность просмотра оставшихся файлов. Ни один файл не должен быть пропущен.</p><br>
<h2 id="na-chto-obraschat-vnimanie-pri-prosmotre">На что обращать внимание при просмотре</h2><br>
<ul>
    <li>Код хорошо спроектирован</li>
    <li>Функциональность хорошо сделана с точки зрения пользователей этого кода, кем бы они ни были.</li>
    <li>Внешний вид (если есть) должен быть хорошим</li>
    <li>Учтены все нюансы параллельного программирования (если есть).</li>
    <li>Код не переусложнен</li>
    <li>Разработчик не оверинженирит: не нужно писать код, который может понадобиться, а может не понадобиться</li>
    <li>У кода есть тесты</li>
    <li>Тесты хорошо спроектированы</li>
    <li>Наименования (для всего) выбраны хорошо</li>
    <li>Комментарии к коду понятны и необходимы. Они должны объяснять, <strong>почему</strong> так сделано, а не <strong>как</strong> это сделано.</li>
    <li>Добавлена документация.</li>
    <li>Код соответствует стайл гайдам.</li>
</ul><br>
<h2 id="slishkom-bolshie-mr">Слишком большие MR</h2><br>
<p>Слишком большие MR нужно просить разбивать на части. Почти всегда это возможно.</p><br>
<h2 id="kak-pisat-kommentarii-na-kod-revyu">Как писать комментарии на код ревью</h2><br>
<ul>
    <li>Нужно быть вежливым, не переходить на личности. Обсуждать код, а не кодера.</li>
    <li>Не просто выдавать директивы к исправлениям, а объяснять, почему нужно исправить.</li>
    <li>Соблюдать баланс: обозначить проблему и подтолкнуть разработчика, чтобы он сам понял, как лучше ее решить; или же сразу выдать готовое решение. Первое развивает разработчика (стратегическая выгода), второе улучшает и ускоряет MR (тактическая выгода).</li>
    <li>Если ревьювер не понял какой-то момент в коде и просит автора объяснить, что к чему, то лучшим ответом будет изменение кода. Так, чтобы было по коду все было понятно без вопросов.</li>
</ul><br>
<h2 id="esli-s-vashim-mneniem-ne-soglasny">Если с вашим мнением не согласны</h2><br>
<p>Нужно разобраться детально. Возможно, вы чего-то не понимаете, запросите больше информации. Возможно наоборот. В любом случае, зачастую понимание приходит только после пары раундов объяснений с обеих сторон.</p><br>
<h2 id="boyazn-rasstroit-avtora-mr">Боязнь расстроить автора MR</h2><br>
<p>Бывает, что разработчик расстраивается, если ревьювер настаивает на каких-то изменениях. Однако, чаще всего разработчики расстраиваются из-за формы замечания, а не из-за содержания. Будьте вежливы, объясняйте аргументами, и скорее всего всё будет ок.</p><br>
<h2 id="ya-ispravlyu-eto-potom">"Я исправлю это потом"</h2><br>
<p>Если разработчик согласен с тем, что в коде есть проблема, но просит заапрувить MR, обещая, что исправит это в другой раз, то, по мнению ребят из Гугла, это "потом" чаще всего никогда не наступает. Поэтому если MR — не какой-то срочный багфикс прода, то нужно настаивать на исправлении.</p><br>
<h2 id="vyvody">Выводы</h2><br>
<p>Мне очень понравился этот документ от Google. Особенно лайфхак со словом "nit", акцент на скорости code review, а также то, что MR не должен быть идеальным. Вроде бы просто, но пока это явно не обдумаешь, до дела не доходит.</p><br>
<p>Если эта статья покажется интересной читателям и наберет какое-то количество плюсов, то я напишу следующую часть: процесс code review со стороны автора MR.</p><br>
<p>Алсо, в ближайшем выпуске "Цинкового прода" мы подробно обсудим код ревью с разных сторон. Поэтому не забудьте подписаться на <a href="https://soundcloud.com/znprod">наш подкаст</a> о разработке!</p>